<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RasPiChamber</title>
    <link rel="stylesheet" href="framework/material-components-web.css" />
</head>
<body>
    <form>
        <div id="innerFanSpeedSlider" class="mdc-slider mdc-slider--discrete">
            <input id="innerFanSpeed" class="mdc-slider__input" type="range" min="0" max="100" value="0" name="fanSpeed" step="1" aria-label="Inner fan speed">
            <div class="mdc-slider__track">
                <div class="mdc-slider__track--inactive"></div>
                <div class="mdc-slider__track--active">
                    <div class="mdc-slider__track--active_fill"></div>
                </div>
            </div>
            <div class="mdc-slider__thumb">
                <div class="mdc-slider__value-indicator-container" aria-hidden="true">
                    <div class="mdc-slider__value-indicator">
                        <span class="mdc-slider__value-indicator-text">0</span>
                    </div>
                </div>
                <div class="mdc-slider__thumb-knob"></div>
            </div>
        </div>
        <div id="outerFanSpeedSlider" class="mdc-slider mdc-slider--discrete">
            <input id="outerFanSpeed" class="mdc-slider__input" type="range" min="0" max="100" value="0" name="fanSpeed" step="1" aria-label="Outer fan speed">
            <div class="mdc-slider__track">
                <div class="mdc-slider__track--inactive"></div>
                <div class="mdc-slider__track--active">
                    <div class="mdc-slider__track--active_fill"></div>
                </div>
            </div>
            <div class="mdc-slider__thumb">
                <div class="mdc-slider__value-indicator-container" aria-hidden="true">
                    <div class="mdc-slider__value-indicator">
                        <span class="mdc-slider__value-indicator-text">0</span>
                    </div>
                </div>
                <div class="mdc-slider__thumb-knob"></div>
            </div>
        </div>
        <div id="rpiFanSpeedSlider" class="mdc-slider mdc-slider--discrete">
            <input id="rpiFanSpeed" class="mdc-slider__input" type="range" min="0" max="100" value="0" name="fanSpeed" step="1" aria-label="RPi fan speed">
            <div class="mdc-slider__track">
                <div class="mdc-slider__track--inactive"></div>
                <div class="mdc-slider__track--active">
                    <div class="mdc-slider__track--active_fill"></div>
                </div>
            </div>
            <div class="mdc-slider__thumb">
                <div class="mdc-slider__value-indicator-container" aria-hidden="true">
                    <div class="mdc-slider__value-indicator">
                        <span class="mdc-slider__value-indicator-text">0</span>
                    </div>
                </div>
                <div class="mdc-slider__thumb-knob"></div>
            </div>
        </div>
        <div id="dryerHatchAngleSlider" class="mdc-slider mdc-slider--discrete mdc-slider--tick-marks">
            <input id="dryerHatchAngle" class="mdc-slider__input" type="range" min="0" max="90" value="0" name="volume" step="1" aria-label="Dryer hatch angle">
            <div class="mdc-slider__track">
                <div class="mdc-slider__track--inactive"></div>
                <div class="mdc-slider__track--active">
                    <div class="mdc-slider__track--active_fill"></div>
                </div>
                <div class="mdc-slider__tick-marks">
                    <div class="mdc-slider__tick-mark--active"></div>
                    <div class="mdc-slider__tick-mark--active"></div>
                    <div class="mdc-slider__tick-mark--active"></div>
                    <div class="mdc-slider__tick-mark--active"></div>
                    <div class="mdc-slider__tick-mark--active"></div>
                    <div class="mdc-slider__tick-mark--active"></div>
                    <div class="mdc-slider__tick-mark--inactive"></div>
                    <div class="mdc-slider__tick-mark--inactive"></div>
                    <div class="mdc-slider__tick-mark--inactive"></div>
                    <div class="mdc-slider__tick-mark--inactive"></div>
                    <div class="mdc-slider__tick-mark--inactive"></div>
                </div>
            </div>
            <div class="mdc-slider__thumb">
                <div class="mdc-slider__value-indicator-container" aria-hidden="true">
                    <div class="mdc-slider__value-indicator">
                        <span class="mdc-slider__value-indicator-text">0</span>
                    </div>
                </div>
                <div class="mdc-slider__thumb-knob"></div>
            </div>
        </div>
    </form>

    <div class="mdc-snackbar">
        <div class="mdc-snackbar__surface" role="status" aria-relevant="additions">
            <div class="mdc-snackbar__label" aria-atomic="false">
                error text
            </div>
            <div class="mdc-snackbar__actions" aria-atomic="true">
                <button class="mdc-icon-button mdc-snackbar__dismiss material-icons" title="Dismiss">close</button>
            </div>
        </div>
    </div>
<script src="framework/material-components-web.js"></script>
<script>
    mdc.autoInit();
    const errorBar = new mdc.snackbar.MDCSnackbar(document.querySelector('.mdc-snackbar'));

    const innerFanSlider = new mdc.slider.MDCSlider(document.querySelector('#innerFanSpeedSlider'));
    innerFanSlider.root.addEventListener('MDCSlider:change', e => {
        setFanSpeedPercent('inner-fan', innerFanSlider.getValue());
    });

    const outerFanSlider = new mdc.slider.MDCSlider(document.querySelector('#outerFanSpeedSlider'));
    outerFanSlider.root.addEventListener('MDCSlider:change', e => {
        setFanSpeedPercent('outer-fan', outerFanSlider.getValue());
    });

    const rpiFanSlider = new mdc.slider.MDCSlider(document.querySelector('#rpiFanSpeedSlider'));
    rpiFanSlider.root.addEventListener('MDCSlider:change', e => {
        setFanSpeedPercent('rpi-fan', rpiFanSlider.getValue());
    });

    const dryerHatchSlider = new mdc.slider.MDCSlider(document.querySelector('#dryerHatchAngleSlider'));
    dryerHatchSlider.root.addEventListener('MDCSlider:change', e => {
        setDryerHatchAngle(rpiFanSlider.getValue());
    });

    updateStatus();

    const updateInterval=1000

    let tid = setTimeout(autoUpdateStatus, updateInterval);
    function autoUpdateStatus() {
        // do some stuff...
        tid = setTimeout(autoUpdateStatus, updateInterval); // repeat myself
    }
    function abortStatusUpdate() {
        clearTimeout(tid);
    }
    
    async function setFanSpeedPercent(fanName, percent) {
        const request = new Request(
            '/devices/' + encodeURIComponent(fanName) + '/set-speed-percent',
            {
                method: 'POST',
                headers: new Headers({'Content-Type': 'application/x-www-form-urlencoded'}),
                body: 'value='+ encodeURIComponent(percent),
            }
        );

        const response = await fetch(request);
        const resultText = await response.text();
        if (!response.ok) {
            showError('Failed to set "' + fanName + '" speed: ' + resultText);
        }
    }

    async function setDryerHatchAngle(angle) {
        const request = new Request(
            '/devices/dryer-hatch/set-angle',
            {
                method: 'POST',
                headers: new Headers({'Content-Type': 'application/x-www-form-urlencoded'}),
                body: 'value='+ encodeURIComponent(angle),
            }
        );

        const response = await fetch(request);
        const resultText = await response.text();
        if (!response.ok) {
            showError('Failed to set dryer hatch angle: ' + resultText);
        }
    }

    async function setDryerState(state) {
        const request = new Request(
            '/devices/dryer-control/set-state',
            {
                method: 'POST',
                headers: new Headers({'Content-Type': 'application/x-www-form-urlencoded'}),
                body: 'value='+ encodeURIComponent(state),
            }
        );

        const response = await fetch(request);
        const resultText = await response.text();
        if (!response.ok) {
            showError('Failed to set dryer state: ' + resultText);
        }
    }

    async function getStatus() {
        const request = new Request(
            '/devices', { method: 'GET' }
        );

        const response = await fetch(request);
        const status = await response.json();
        if (!response.ok) {
            showError('Failed to get status');
        }

        return status
    }

    function updateStatus() {
        getStatus().then(status => {
            console.log(status)
        });
    }

    function showError(errorText) {
        errorBar.labelText = errorText;
        errorBar.open()
    }
</script>
</body>
</html>