<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RasPiChamber</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Rubik:300,400,500">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Mono">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,600,700">
    <link rel="stylesheet" href="framework/material-components-web.css" />
</head>
<body class="mdc-typography">
    <form>
        <div id="auto-update-switch" class="mdc-switch mdc-switch--checked">
            <div class="mdc-switch__track"></div>
            <div class="mdc-switch__thumb-underlay">
                <div class="mdc-switch__thumb"></div>
                <input type="checkbox" id="auto-update-switch-checkbox" class="mdc-switch__native-control" role="switch" aria-checked="true" checked>
            </div>
        </div>
        <label for="auto-update-switch-checkbox">on/off automatic updates</label>
        <p> INNER FAN
            <div id="inner-fan-speed-slider" class="mdc-slider mdc-slider--discrete">
                <input id="innerFanSpeed" class="mdc-slider__input" type="range" min="0" max="100" value="0" name="fanSpeed" step="1" aria-label="Inner fan speed">
                <div class="mdc-slider__track">
                    <div class="mdc-slider__track--inactive"></div>
                    <div class="mdc-slider__track--active">
                        <div class="mdc-slider__track--active_fill"></div>
                    </div>
                </div>
                <div class="mdc-slider__thumb">
                    <div class="mdc-slider__value-indicator-container" aria-hidden="true">
                        <div class="mdc-slider__value-indicator">
                            <span class="mdc-slider__value-indicator-text">0</span>
                        </div>
                    </div>
                    <div class="mdc-slider__thumb-knob"></div>
                </div>
            </div>
        </p>
        <p> OUTER FAN
            <div id="outerFanSpeedSlider" class="mdc-slider mdc-slider--discrete">
                <input id="outerFanSpeed" class="mdc-slider__input" type="range" min="0" max="100" value="0" name="fanSpeed" step="1" aria-label="Outer fan speed">
                <div class="mdc-slider__track">
                    <div class="mdc-slider__track--inactive"></div>
                    <div class="mdc-slider__track--active">
                        <div class="mdc-slider__track--active_fill"></div>
                    </div>
                </div>
                <div class="mdc-slider__thumb">
                    <div class="mdc-slider__value-indicator-container" aria-hidden="true">
                        <div class="mdc-slider__value-indicator">
                            <span class="mdc-slider__value-indicator-text">0</span>
                        </div>
                    </div>
                    <div class="mdc-slider__thumb-knob"></div>
                </div>
            </div>
        </p>
        <p> RPi FAN
            <div id="rpiFanSpeedSlider" class="mdc-slider mdc-slider--discrete">
                <input id="rpiFanSpeed" class="mdc-slider__input" type="range" min="0" max="100" value="0" name="fanSpeed" step="1" aria-label="RPi fan speed">
                <div class="mdc-slider__track">
                    <div class="mdc-slider__track--inactive"></div>
                    <div class="mdc-slider__track--active">
                        <div class="mdc-slider__track--active_fill"></div>
                    </div>
                </div>
                <div class="mdc-slider__thumb">
                    <div class="mdc-slider__value-indicator-container" aria-hidden="true">
                        <div class="mdc-slider__value-indicator">
                            <span class="mdc-slider__value-indicator-text">0</span>
                        </div>
                    </div>
                    <div class="mdc-slider__thumb-knob"></div>
                </div>
            </div>
        </p>
        <p> DRYER HATCH ANGLE
            <div id="dryerHatchAngleSlider" class="mdc-slider mdc-slider--discrete mdc-slider--tick-marks">
                <input id="dryerHatchAngle" class="mdc-slider__input" type="range" min="0" max="90" value="0" name="volume" step="1" aria-label="Dryer hatch angle">
                <div class="mdc-slider__track">
                    <div class="mdc-slider__track--inactive"></div>
                    <div class="mdc-slider__track--active">
                        <div class="mdc-slider__track--active_fill"></div>
                    </div>
                    <div class="mdc-slider__tick-marks">
                        <div class="mdc-slider__tick-mark--active"></div>
                        <div class="mdc-slider__tick-mark--inactive"></div>
                    </div>
                </div>
                <div class="mdc-slider__thumb">
                    <div class="mdc-slider__value-indicator-container" aria-hidden="true">
                        <div class="mdc-slider__value-indicator">
                            <span class="mdc-slider__value-indicator-text">0</span>
                        </div>
                    </div>
                    <div class="mdc-slider__thumb-knob"></div>
                </div>
            </div>
        </p>
        <p> DRYER CONTROL
            <div>
                <div id="dryer-switch" class="mdc-switch">
                    <div class="mdc-switch__track"></div>
                    <div class="mdc-switch__thumb-underlay">
                        <div class="mdc-switch__thumb"></div>
                        <input type="checkbox" id="dryer-switch-checkbox" class="mdc-switch__native-control" role="switch" aria-checked="false">
                    </div>
                </div>
                <div id="dryer-state-slider" class="mdc-slider mdc-slider--discrete mdc-slider--tick-marks">
                    <input id="dryer-state" class="mdc-slider__input" type="range" min="35" max="70" value="35" name="volume" step="5" aria-label="Dryer temperature">
                    <div class="mdc-slider__track">
                        <div class="mdc-slider__track--inactive"></div>
                        <div class="mdc-slider__track--active">
                            <div class="mdc-slider__track--active_fill"></div>
                        </div>
                        <div class="mdc-slider__tick-marks">
                            <div class="mdc-slider__tick-mark--active"></div>
                            <div class="mdc-slider__tick-mark--inactive"></div>
                        </div>
                    </div>
                    <div class="mdc-slider__thumb">
                        <div class="mdc-slider__value-indicator-container" aria-hidden="true">
                            <div class="mdc-slider__value-indicator">
                                <span class="mdc-slider__value-indicator-text">35</span>
                            </div>
                        </div>
                        <div class="mdc-slider__thumb-knob"></div>
                    </div>
                </div>
            </div>
        </p>
        <p> INNER THERMOMETER
            <label id="inner-temp-field" class="mdc-text-field mdc-text-field--outlined mdc-text-field--label-floating mdc-text-field--disabled">
                <span class="mdc-notched-outline">
                    <span class="mdc-notched-outline__leading"></span>
                    <span class="mdc-notched-outline__notch">
                        <span class="mdc-floating-label mdc-floating-label--float-above" id="inner-temp-label-id">Temperature</span>
                    </span>
                    <span class="mdc-notched-outline__trailing"></span>
                </span>
                <input type="text" class="mdc-text-field__input" aria-labelledby="inner-temp-label-id" value="00.0" disabled>
                <span class="mdc-text-field__affix mdc-text-field__affix--suffix">°C</span>
            </label>
            <label id="inner-humidity-field" class="mdc-text-field mdc-text-field--outlined mdc-text-field--label-floating mdc-text-field--disabled">
                <span class="mdc-notched-outline">
                    <span class="mdc-notched-outline__leading"></span>
                    <span class="mdc-notched-outline__notch">
                        <span class="mdc-floating-label mdc-floating-label--float-above" id="inner-humidity-label-id">Humidity</span>
                    </span>
                    <span class="mdc-notched-outline__trailing"></span>
                </span>
                <input type="text" class="mdc-text-field__input" aria-labelledby="inner-humidity-label-id" value="00" disabled>
                <span class="mdc-text-field__affix mdc-text-field__affix--suffix">%</span>
            </label>
        </p>

        <p> OUTER THERMOMETER
            <label id="outer-temp-field" class="mdc-text-field mdc-text-field--outlined mdc-text-field--label-floating mdc-text-field--disabled">
                <span class="mdc-notched-outline">
                    <span class="mdc-notched-outline__leading"></span>
                    <span class="mdc-notched-outline__notch">
                        <span class="mdc-floating-label mdc-floating-label--float-above" id="outer-temp-label-id">Temperature</span>
                    </span>
                    <span class="mdc-notched-outline__trailing"></span>
                </span>
                <input type="text" class="mdc-text-field__input" aria-labelledby="outer-temp-label-id" value="00.0" disabled>
                <span class="mdc-text-field__affix mdc-text-field__affix--suffix">°C</span>
            </label>
            <label id="outer-humidity-field" class="mdc-text-field mdc-text-field--outlined mdc-text-field--label-floating mdc-text-field--disabled">
                <span class="mdc-notched-outline">
                    <span class="mdc-notched-outline__leading"></span>
                    <span class="mdc-notched-outline__notch">
                        <span class="mdc-floating-label mdc-floating-label--float-above" id="outer-humidity-label-id">Humidity</span>
                    </span>
                    <span class="mdc-notched-outline__trailing"></span>
                </span>
                <input type="text" class="mdc-text-field__input" aria-labelledby="outer-humidity-label-id" value="00" disabled>
                <span class="mdc-text-field__affix mdc-text-field__affix--suffix">%</span>
            </label>
        </p>
        <p> DRYER THERMOMETER
            <label id="dryer-temp-field" class="mdc-text-field mdc-text-field--outlined mdc-text-field--label-floating mdc-text-field--disabled">
                <span class="mdc-notched-outline">
                    <span class="mdc-notched-outline__leading"></span>
                    <span class="mdc-notched-outline__notch">
                        <span class="mdc-floating-label mdc-floating-label--float-above" id="dryer-temp-label-id">Temperature</span>
                    </span>
                    <span class="mdc-notched-outline__trailing"></span>
                </span>
                <input type="text" class="mdc-text-field__input" aria-labelledby="dryer-temp-label-id" value="00.0" disabled>
                <span class="mdc-text-field__affix mdc-text-field__affix--suffix">°C</span>
            </label>
            <label id="dryer-humidity-field" class="mdc-text-field mdc-text-field--outlined mdc-text-field--label-floating mdc-text-field--disabled">
                <span class="mdc-notched-outline">
                    <span class="mdc-notched-outline__leading"></span>
                    <span class="mdc-notched-outline__notch">
                        <span class="mdc-floating-label mdc-floating-label--float-above" id="dryer-humidity-label-id">Humidity</span>
                    </span>
                    <span class="mdc-notched-outline__trailing"></span>
                </span>
                <input type="text" class="mdc-text-field__input" aria-labelledby="dryer-humidity-label-id" value="00" disabled>
                <span class="mdc-text-field__affix mdc-text-field__affix--suffix">%</span>
            </label>
        </p>

        <p> INNER FAN
            <label id="inner-fan-rpm-field" class="mdc-text-field mdc-text-field--outlined mdc-text-field--label-floating mdc-text-field--disabled">
                <span class="mdc-notched-outline">
                    <span class="mdc-notched-outline__leading"></span>
                    <span class="mdc-notched-outline__notch">
                        <span class="mdc-floating-label mdc-floating-label--float-above" id="inner-fan-rpm-label-id">Rate</span>
                    </span>
                    <span class="mdc-notched-outline__trailing"></span>
                </span>
                <input type="text" class="mdc-text-field__input" aria-labelledby="inner-fan-rpm-label-id" value="00" disabled>
                <span class="mdc-text-field__affix mdc-text-field__affix--suffix">RPM</span>
            </label>
        </p>

        <p> OUTER FAN
            <label id="outer-fan-rpm-field" class="mdc-text-field mdc-text-field--outlined mdc-text-field--label-floating mdc-text-field--disabled">
                <span class="mdc-notched-outline">
                    <span class="mdc-notched-outline__leading"></span>
                    <span class="mdc-notched-outline__notch">
                        <span class="mdc-floating-label mdc-floating-label--float-above" id="outer-fan-rpm-label-id">Rate</span>
                    </span>
                    <span class="mdc-notched-outline__trailing"></span>
                </span>
                <input type="text" class="mdc-text-field__input" aria-labelledby="outer-fan-rpm-label-id" value="00" disabled>
                <span class="mdc-text-field__affix mdc-text-field__affix--suffix">RPM</span>
            </label>
        </p>
        <p> RPI FAN
            <label id="rpi-fan-rpm-field" class="mdc-text-field mdc-text-field--outlined mdc-text-field--label-floating mdc-text-field--disabled">
                <span class="mdc-notched-outline">
                    <span class="mdc-notched-outline__leading"></span>
                    <span class="mdc-notched-outline__notch">
                        <span class="mdc-floating-label mdc-floating-label--float-above" id="rpi-fan-rpm-label-id">Rate</span>
                    </span>
                    <span class="mdc-notched-outline__trailing"></span>
                </span>
                <input type="text" class="mdc-text-field__input" aria-labelledby="rpi-fan-rpm-label-id" value="00" disabled>
                <span class="mdc-text-field__affix mdc-text-field__affix--suffix">RPM</span>
            </label>
        </p>
    </form>

    <div id="error-snackbar" class="mdc-snackbar">
        <div class="mdc-snackbar__surface" role="status" aria-relevant="additions">
            <div class="mdc-snackbar__label" aria-atomic="false">
                error text
            </div>
            <div class="mdc-snackbar__actions" aria-atomic="true">
                <button id="error-snackbar-dismiss" class="mdc-icon-button mdc-snackbar__dismiss material-icons" title="Dismiss">close</button>
            </div>
        </div>
    </div>
<script src="framework/material-components-web.js"></script>
<script>
    // TODO: 'fetch' error handling with try/catch
    const updateInterval=1000;
    let timeoutId = null;
    let autoUpdateEnabled = true;

    mdc.autoInit();
    const errorBar = new mdc.snackbar.MDCSnackbar(document.querySelector('#error-snackbar'));

    const autoUpdateSwitch = new mdc.switchControl.MDCSwitch(document.querySelector('#auto-update-switch'));
    const autoUpdateSwitchCheckBox = document.querySelector('#auto-update-switch-checkbox');
    autoUpdateSwitchCheckBox.addEventListener('change', _ => {
        disableStatusUpdate();
        autoUpdateEnabled = autoUpdateSwitch.checked;
        enableStatusUpdate();
    });

    const innerFanSlider = new mdc.slider.MDCSlider(document.querySelector('#inner-fan-speed-slider'));
    innerFanSlider.root.addEventListener('MDCSlider:change', e => {
        disableStatusUpdate();
        setFanSpeedPercent('inner-fan', innerFanSlider.getValue());
        enableStatusUpdate();
    });

    const outerFanSlider = new mdc.slider.MDCSlider(document.querySelector('#outerFanSpeedSlider'));
    outerFanSlider.root.addEventListener('MDCSlider:change', e => {
        disableStatusUpdate();
        setFanSpeedPercent('outer-fan', outerFanSlider.getValue());
        enableStatusUpdate();
    });

    const rpiFanSlider = new mdc.slider.MDCSlider(document.querySelector('#rpiFanSpeedSlider'));
    rpiFanSlider.root.addEventListener('MDCSlider:change', e => {
        disableStatusUpdate();
        setFanSpeedPercent('rpi-fan', rpiFanSlider.getValue());
        enableStatusUpdate();
    });

    const dryerHatchSlider = new mdc.slider.MDCSlider(document.querySelector('#dryerHatchAngleSlider'));
    dryerHatchSlider.root.addEventListener('MDCSlider:change', e => {
        disableStatusUpdate();
        setDryerHatchAngle(dryerHatchSlider.getValue());
        enableStatusUpdate();
    });

    const innerTempField = new mdc.textField.MDCTextField(document.querySelector('#inner-temp-field'));
    const innerHumidityField = new mdc.textField.MDCTextField(document.querySelector('#inner-humidity-field'));

    const outerTempField = new mdc.textField.MDCTextField(document.querySelector('#outer-temp-field'));
    const outerHumidityField = new mdc.textField.MDCTextField(document.querySelector('#outer-humidity-field'));

    const dryerTempField = new mdc.textField.MDCTextField(document.querySelector('#dryer-temp-field'));
    const dryerHumidityField = new mdc.textField.MDCTextField(document.querySelector('#dryer-humidity-field'));

    const innerFanRPMField = new mdc.textField.MDCTextField(document.querySelector('#inner-fan-rpm-field'));
    const outerFanRPMField = new mdc.textField.MDCTextField(document.querySelector('#outer-fan-rpm-field'));
    const rpiFanRPMField = new mdc.textField.MDCTextField(document.querySelector('#rpi-fan-rpm-field'));

    const dryerStateSlider = new mdc.slider.MDCSlider(document.querySelector('#dryer-state-slider'));
    dryerStateSlider.root.addEventListener('MDCSlider:change', e => {
        disableStatusUpdate();
        setDryerState();
        enableStatusUpdate();
    });

    const dryerSwitch = new mdc.switchControl.MDCSwitch(document.querySelector('#dryer-switch'));
    const dryerSwitchCheckBox = document.querySelector('#dryer-switch-checkbox');
    dryerSwitchCheckBox.addEventListener('change', _ => {
        dryerStateSlider.setDisabled(!dryerSwitch.checked);

        disableStatusUpdate();
        setDryerState();
        enableStatusUpdate();
    });

    updateStatus();
    enableStatusUpdate();

    function enableStatusUpdate() {
        if (!autoUpdateEnabled) {
            return
        }

        timeoutId = setTimeout(autoUpdateStatus, updateInterval);

        function autoUpdateStatus() {
            updateStatus();
            timeoutId = setTimeout(autoUpdateStatus, updateInterval);
        }
    }

    function disableStatusUpdate() {
        if (timeoutId != null) {
            clearTimeout(timeoutId);
        }
    }
    
    async function setFanSpeedPercent(fanName, percent) {
        const request = new Request(
            '/devices/' + encodeURIComponent(fanName) + '/set-speed-percent',
            {
                method: 'POST',
                headers: new Headers({'Content-Type': 'application/x-www-form-urlencoded'}),
                body: 'value='+ encodeURIComponent(percent),
            }
        );

        const response = await fetch(request);
        if (!response.ok) {
            showError('Failed to set "' + fanName + '" speed: ' + response.statusText);
        }
    }

    async function setDryerHatchAngle(angle) {
        const request = new Request(
            '/devices/dryer-hatch/set-angle',
            {
                method: 'POST',
                headers: new Headers({'Content-Type': 'application/x-www-form-urlencoded'}),
                body: 'value='+ encodeURIComponent(angle),
            }
        );

        const response = await fetch(request);
        if (!response.ok) {
            showError('Failed to set dryer hatch angle: ' + response.statusText);
        }
    }

    async function setDryerState() {
        let state = 'off'
        if (dryerSwitch.checked) {
            state = 'on' + dryerStateSlider.getValue() + 'degrees';
        }

        console.log(state)

        const request = new Request(
            '/devices/dryer-control/set-state',
            {
                method: 'POST',
                headers: new Headers({'Content-Type': 'application/x-www-form-urlencoded'}),
                body: 'value='+ encodeURIComponent(state),
            }
        );

        const response = await fetch(request);
        if (!response.ok) {
            showError('Failed to set dryer state: ' + response.statusText);
        }
    }

    async function getStatus() {
        const request = new Request(
            '/devices', { method: 'GET' }
        );

        const response = await fetch(request);
        if (!response.ok) {
            showError('Failed to get status: ' + response.statusText);
            return null;
        }

        return await response.json()
    }

    function updateStatus() {
        getStatus().then(status => {
            if (status == null) {
                return;
            }

            const devices = status.devices;
            if (devices === undefined) {
                return;
            }

            updateThermometer(devices.inner_thermometer, innerTempField, innerHumidityField);
            updateThermometer(devices.outer_thermometer, outerTempField, outerHumidityField);
            updateThermometer(devices.dryer_thermometer, dryerTempField, dryerHumidityField);

            updateFan(devices.inner_fan, innerFanSlider, innerFanRPMField);
            updateFan(devices.outer_fan, outerFanSlider, outerFanRPMField);
            updateFan(devices.rpi_fan, rpiFanSlider, rpiFanRPMField);

            updateDryerState(devices.dryer_control);
            updateDryerHatch(devices.dryer_hatch);
        });
    }

    function updateThermometer(thermometer, tempField, humidityField) {
        if (thermometer === undefined) {
            return;
        }

        const temp = thermometer.temperature;
        if (temp !== undefined) {
            tempField.value = temp;
        }

        const hum = thermometer.humidity;
        if (hum !== undefined) {
            humidityField.value = hum;
        }
    }

    function updateFan(fan, speedField, rpmField) {
        if (fan === undefined) {
            return;
        }

        const speed = fan.speed_percent;
        if (speed !== undefined) {
            speedField.setValue(speed);
        }

        const rpm = fan.rpm;
        if (rpm !== undefined) {
            rpmField.value = rpm;
        }
    }

    function updateDryerState(dryerControl) {
        if (dryerControl === undefined) {
            return;
        }

        const state = dryerControl.state;
        if (state === undefined) {
            return;
        }

        switch (state) {
            case 'off':
                break;
            case 'on35degrees':
                dryerStateSlider.setValue(35);
                break;
            case 'on40degrees':
                dryerStateSlider.setValue(40);
                break;
            case 'on45degrees':
                dryerStateSlider.setValue(45);
                break;
            case 'on50degrees':
                dryerStateSlider.setValue(50);
                break;
            case 'on55degrees':
                dryerStateSlider.setValue(55);
                break;
            case 'on60degrees':
                dryerStateSlider.setValue(60);
                break;
            case 'on65degrees':
                dryerStateSlider.setValue(65);
                break;
            case 'on70degrees':
                dryerStateSlider.setValue(70);
                break;
            default:
                showError("Unknown dryer state '" + state + "'");
                return;
        }

        if (state === 'off') {
            dryerSwitch.checked = false;
            dryerStateSlider.setDisabled(true);
        } else {
            dryerSwitch.checked = true;
            dryerStateSlider.setDisabled(false);
        }
    }

    function updateDryerHatch(dryerHatch) {
        if (dryerHatch === undefined) {
            return;
        }

        const angle = dryerHatch.angle;
        if (angle === undefined) {
            return;
        }

        dryerHatchSlider.setValue(angle);
    }

    function showError(errorText) {
        errorBar.labelText = errorText;
        errorBar.open()
    }
</script>
</body>
</html>